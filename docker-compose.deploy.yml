# Override used when deploying to server (run with docker-compose.yml)
# Example: docker compose -f docker-compose.yml -f docker-compose.deploy.yml up -d --build
#
# Data lake path (no sudo):
#   Default: LAKEFLOW_DATA_PATH=$REPO_DIR/data (set in deploy workflow)
#   Server custom: export LAKEFLOW_DATA_PATH=/datalake/research (create dir with sudo once, then deploy user needs rwx)
#
# Qdrant: default uses named volume (data in /var/lib/docker/volumes/..., persists across down).
#   To use a fixed host dir: export QDRANT_DATA_PATH=/datalake/qdrant, create the dir then deploy.
#
# - Backend: no source mount, no --reload
# - Frontend: no mount of ./lake-flow-ui

services:
  lakeflow-backend:
    volumes:
      - lakeflow_data:/data
    command: uvicorn lakeflow.main:app --host 0.0.0.0 --port 8011
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8011/health"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 15s

  lakeflow-frontend:
    volumes:
      - lakeflow_data:/data

# Bind volume to LAKEFLOW_DATA_PATH (default: repo/data, no sudo) or set on server for e.g. /datalake/research
# Qdrant: still uses named volume from docker-compose.yml (data persists on down). To bind host dir: add override qdrant_data with device: /datalake/qdrant.
volumes:
  lakeflow_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${LAKEFLOW_DATA_PATH:-./data} 